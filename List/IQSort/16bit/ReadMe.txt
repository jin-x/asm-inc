##################################################
##                                              ##
##           [ Asm7x.List ][ IQSort ]           ##
##                                              ##
##            -= Smart Quick Sort =-            ##
##           Умная быстрая сортировка           ##
##                                              ##
##           [ v1.00 :: 11.11.2017 ]            ##
##              MASM/TASM (16 bit)              ##
##                                              ##
##     (c) 2017 by Jin X (jin.x@sources.ru)     ##
##             http://xk7.ru/p/a/i              ##
##                                              ##
##################################################


=========
О МОДУЛЯХ
=========

Данный архив включает в себя несколько include-файлов для 16-битных программ на ассемблере, компилируемых с помощью TASM/MASM/UASM.
Файлы содержат процедуры сортировки массивов несколькими вариантами:
• "умной" быстрой сортировкой (быстрой сортировкой, использующей сортировку вставками при некоторых условиях, см. ниже),
• быстрой сортировкой (с одним рекурсивным вызовом),
• сортировкой вставками.

По умолчанию используется быстрая сортировка, однако если кол-во элементов массива на первой или последующей итерации меньше некоего порогового значения (по умолчанию 16), либо если для следующего уровня рекурсии в общей сложности потребуется слишком много стека (по умолчанию 128 байт), используется сортировка вставками, в которой рекурсия отсутствует. Это немного ускоряет процесс и защищает стек от переполнения.

Иногда при сортировке массивов необходимо упорядочить не только числовые элементы, но и соответствующие им данные. Например, имеется список людей с указанием года рождения и фамилии для каждого из них. Год рождения записан в виде числового значения, а фамилия – в виде указателя на строку. Таким образом, каждый элемент массива будет содержать 2 записи размером WORD каждая:
  +0  WORD  Год рождения
  +2  WORD  Адрес (смещение) строки с фамилией
При сортировке такого массива по году рождения необходимо сравнивать только первые элементы (опорные значения), однако перемещать (менять местами) и первые, и вторые.
Если массив должен содержать более 2-х элементов, все элементы, кроме опорного (например, фамилию, имя, адрес и телефон) можно записать в отдельную область памяти, а во втором поле указать ссылку на эту структуру.

Данные процедуры позволяют выполнить как сортировку одиночных (числовых) элементов, так и двойных (числовых элементов с привязанными данными).
Некоторые файлы содержат универсальные процедуры (размер данных, присутствия знака в числовых значениях и направление сортировки, а также другие настройки задаются в исходнике программы *перед* подключением файла), другие – с заданными настройками, некоторые из которых можно менять, изменяя сам исходник.

!!! ВАЖНО !!!
В случае внесения изменений в текст include-файла необходимо в его заголовок добавить комментарий о том, что он модифицирован (с указанием имени автора внесения изменений, желательно также изменить и имя файла), чтобы при переносе на другой компьютер или в другой проект не возникло неожиданностей (сделайте это, даже если вы не планируете переносить файл в другое место). И заодно чтобы не нарушать авторские права :)

Процедура быстрой сортировки оптимизирована таким образом, что каждый последующий уровень рекурсии не требует записи в стек адреса возврата (поскольку рекурсивный вызов происходит из одной и той же точки в процедуре), в стек записываются лишь локальные данные, минимально необходимые для последующей работы (2 слово = 4 байта).

Редакцию модулей, позволяющих работать с 32-битными данными (элементами типа DWORD) можно также скачать по ссылке, указанной в заголовках файлов или в конце данного текста.


==============
ВЫЗОВ ПРОЦЕДУР
==============

Разные include-файлы содержат разные процедуры (см. ниже), однако формат вызова всех процедур одинаков. Параметры передаются через регистры: DS:DX = адрес массива, CX = кол-во элементов массива.
Процедуры модифицируют регистры общего назначения, кроме регистра BP (и SP, разумеется). Некоторые из процедур (InsSort, InsSortDE) также сохраняют CX и DX, но лучше на это не опираться, поскольку в будущих версиях (если они будут) это не гарантируется.

Файлы с именами без суффиксов (S1, S2) содержат много директив условной компиляции и констант и могут быть сложны для понимания. Однако они более универсальны и включают в код только ту часть, которая необходима. Например, вы можете указать необходимые настройки в исходном коде своей программы, *после* чего включить процедуру сортировки следующим образом:

  inclInsSort = 1	; включить в код полную процедуру сортировки вставками для использования её отдельно от процедуры умной быстрой сортировки (по умолчанию включается только используемая процедурой IQSort часть)
  SortSignCmp = 0	; беззнаковое сравнение
  SortAscending = 0	; сортировка значений по убыванию
  SortElemWords = 2	; элементы массива имеют 2 слова в каждом элементе (допускается использовать только значение 1 или 2)
  IQSortInsThrs = 16	; использовать сортировку вставками для массивов, в которых меньше 16 элементов [это значение установлено по умолчанию]
  IQSortMaxStk = 128	; максимальный размер стека в байтах, который допустимо использовать процедуре IQSort (включая call из основного кода) [это значение установлено по умолчанию]
  INCLUDE IQSort.inc	; включить процедуру в проект

Единственной требуемой настройкой является SortElemWords, остальные могут быть опущены – в этом случае используются значения по умолчанию. Подробное описание каждой настройки смотрите в исходниках :)
Далее для вызова процедуры сортировки необходимо загрузить требуемые значения в регистры и вызвать процедуру:

  lea dx,Array		; DS:DX = адрес массива
  mov cx,Count		; CX = кол-во элементов массива
  call IQSort		; вызов процедуры умной сортировки

Файлы с суффиксами S1 и S2 (Simple Single/Double) содержат минимальное кол-во настроек, которые хранятся внутри самих модулей (либо эти настройки отсутствуют вовсе). Для изменения некоторых настроек (например, присутствия знака в числовых значениях или направления сортировки) придётся править исходники (правда, сделать это легко – в этих файлах есть описание этого незамысловатого процесса). Эти файлы практически не содержат директив условной компиляции и более понятны для изучения.


================
СТРУКТУРА ФАЙЛОВ
================

В своём проекте вы можете использовать тот include-файл и вариант сортировки, который вам наиболее удобен и понятен.

IQSort.inc – универсальный модуль умной быстрой сортировки (включает в себя процедуру быстрой сортировки IQSort и процедуру сортировки вставками InsSort)
IQSortS1.inc – модуль умной быстрой сортировки для массивов с одиночными элементами (процедуры IQSort и InsSort)
IQSortS2.inc – модуль умной быстрой сортировки для массивов с двойными элементами (процедуры IQSortDE и InsSortDE)

QSort.inc – универсальный модуль обычной быстрой сортировки (процедура QSort)
QSortS1.inc – модуль обычной быстрой сортировки для массивов с одиночными элементами (процедура QSort)
QSortS2.inc – модуль обычной быстрой сортировки для массивов с двойными элементами (процедура QSortDE)

ISort.inc – универсальный модуль сортировки вставками (процедура InsSort)
ISortS1.inc – модуль сортировки вставками для массивов с одиночными элементами (процедура InsSort)
ISortS2.inc – модуль сортировки вставками для массивов с двойными элементами (процедура InsSortDE)

ReadMe.txt – описание архива с модулями сортировки

examples\... – примеры использования процедур сортировки (тестовые программы)

  IQSort1.asm – умная быстрая сортировка массива с одиночными элементами по возрастанию, используя IQSort.inc
  IQSort1D.asm – умная быстрая сортировка массива с одиночными элементами по убыванию, используя IQSort.inc
  IQSort2.asm – умная быстрая сортировка массива с двойными элементами по возрастанию, используя IQSort.inc
  IQSort2D.asm – умная быстрая сортировка массива с двойными элементами по убыванию, используя IQSort.inc
  IQSortS1.asm – умная быстрая сортировка массива с одиночными элементами по возрастанию, используя IQSortS1.inc
  IQSortS2.asm – умная быстрая сортировка массива с двойными элементами по возрастанию, используя IQSortS2.inc

  QSort1.asm – обычная быстрая сортировка массива с одиночными элементами по возрастанию, используя QSort.inc
  QSort1D.asm – обычная быстрая сортировка массива с одиночными элементами по убыванию, используя QSort.inc
  QSort2.asm – обычная быстрая сортировка массива с двойными элементами по возрастанию, используя QSort.inc
  QSort2D.asm – обычная быстрая сортировка массива с двойными элементами по убыванию, используя QSort.inc
  QSortS1.asm – обычная быстрая сортировка массива с одиночными элементами по возрастанию, используя QSortS1.inc
  QSortS2.asm – обычная быстрая сортировка массива с двойными элементами по возрастанию, используя QSortS2.inc

  ISort1.asm – сортировка вставками массива с одиночными элементами по возрастанию, используя ISort.inc
  ISort1D.asm – сортировка вставками массива с одиночными элементами по убыванию, используя ISort.inc
  ISort2.asm – сортировка вставками массива с двойными элементами по возрастанию, используя ISort.inc
  ISort2D.asm – сортировка вставками массива с двойными элементами по убыванию, используя ISort.inc
  ISortS1.asm – сортировка вставками массива с одиночными элементами по возрастанию, используя ISortS1.inc
  ISortS2.asm – сортировка вставками массива с двойными элементами по возрастанию, используя ISortS2.inc

  Для компиляции этих программ необходимо перенести include-файлы в папку с исходником.

  exe\... – исполняемые файлы программ под DOS.

Во всех файлах (кроме того, что вы сейчас читаете) используется кодировка OEM-866 (DOS), поскольку хранящийся в них код написан для программ под DOS.


=========
ОБ АВТОРЕ
=========

Данные модули написаны Евгением Красниковым (aka Jin X) в 2017 году.
Замечания и предложения присылайте на e-mail jin.x@sources.ru или в Telegram @jinxonik (все контакты на сайте http://xk7.ru).
Самую свежую версию можно скачать на сайте http://xk7.ru/p/a/i.
Мои проекты на ассемблере можно найти также на форумах (cyberforum.ru, forum.sources.ru, wasm.in, programmersforum.ru) по метке/ключевому слову "asm7x" (без кавычек).
